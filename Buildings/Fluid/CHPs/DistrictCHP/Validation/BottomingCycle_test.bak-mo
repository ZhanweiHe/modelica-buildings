within GED.DistrictElectrical.CHP.Validation;
model BottomingCycle_test
  extends Modelica.Icons.Example;
    package MediumSte = Buildings.Media.Steam
    "Steam medium - Medium model for port_b (outlet)";
  package MediumWat =
      Buildings.Media.Specialized.Water.TemperatureDependentDensity
    "Water medium - Medium model for port_a (inlet)";

  // Parameters
  parameter Real a[:]={-0.23380344533,0.220477944738,-0.01476897980}
  "Polynominal coefficients for exhaust exergy efficiency";
  parameter Modelica.Units.NonSI.Temperature_degC TSta = 87.778
    "Exhaust stack temperature in Celsius";

   //parameter Modelica.Units.SI.MassFlowRate m_flow_nominal=28.63 "Nominal mass flow rate";
  parameter Modelica.Units.SI.MassFlowRate m_flow_nominal=56.9972
    "Nominal mass flow rate";

  GED.DistrictElectrical.CHP.BottomingCycle botCyc(
    final a=a,
    TSta=182.486,
    final m_flow_nominal=m_flow_nominal,
    a_SteMas={0.2150,0,0},
    steBoi(
      allowFlowReversal=false,
      energyDynamics=Modelica.Fluid.Types.Dynamics.FixedInitial,
      massDynamics=Modelica.Fluid.Types.Dynamics.FixedInitial,
      p_start=3000000,
      V=800,
      VWat_start=0.8*botCyc.steBoi.V,
      VWat_flow(start=0.05),
      fixed_p_start=true),
    TSte(y=235),
    conPID(
      controllerType=Modelica.Blocks.Types.SimpleController.PI,
      k=2,
      Ti=300,
      Td=0,
      yMax=1,
      yMin=0,
      Ni=1,
      Nd=1,
      initType=Modelica.Blocks.Types.Init.NoInit,
      reverseActing=true,
      y(start=1, fixed=true)),
    pump(
      p_a_start=30000,
      p_b_start=3000000,
      m_flow_start=55,
      use_T_start=false,
      T_start=504.475,
      h_start=1e5),
    watLevel(y=0.8*botCyc.steBoi.V))
    annotation (Placement(transformation(extent={{-10,-10},{10,10}})));
  Modelica.Blocks.Sources.Constant ambTemp(k=15) "Ambient temperature (deg_C)"
    annotation (Placement(transformation(extent={{-80,10},{-60,30}})));
  Buildings.Fluid.Sources.Boundary_pT sou(
    redeclare package Medium = MediumWat,
    use_p_in=false,
    p=30000,
    nPorts=1,
    T=504.475)
    annotation (Placement(transformation(extent={{-50,-50},{-30,-30}})));
  Modelica.Fluid.Sources.FixedBoundary bou(
    redeclare package Medium = MediumSte,
    p=1000000,
    T=523.15,
    nPorts=1) "Boundary condition"
    annotation (Placement(transformation(extent={{48,-50},{28,-30}})));
  Modelica.Blocks.Sources.Ramp exTem(
    height=-100,
    duration=3000,
    offset=750,
    startTime=0)
    annotation (Placement(transformation(extent={{-2,74},{18,94}})));
  Modelica.Blocks.Sources.Constant exhMass(k=520)
    "Exhaust gas mass flow rate (kg/s)"
    annotation (Placement(transformation(extent={{-80,-42},{-60,-22}})));
  Modelica.Blocks.Sources.Constant exhTep1(k=750) "Exhaust gas temperature (C)"
    annotation (Placement(transformation(extent={{-80,50},{-60,70}})));
equation
  connect(botCyc.TAmb, ambTemp.y) annotation (Line(points={{-11.3,7},{-11.3,6},
          {-40,6},{-40,20},{-59,20}}, color={0,0,127}));
  connect(botCyc.port_a, sou.ports[1]) annotation (Line(points={{-10,1.11111},{
          -20,1.11111},{-20,-40},{-30,-40}},
                                color={0,127,255}));
  connect(botCyc.port_b, bou.ports[1]) annotation (Line(points={{10,1.11111},{
          20,1.11111},{20,-40},{28,-40}},
                             color={0,127,255}));
  connect(exhMass.y, botCyc.mExh) annotation (Line(points={{-59,-32},{-54,-32},
          {-54,-20},{-40,-20},{-40,2},{-26,2},{-26,3.44444},{-11.3,3.44444}},
                                                                     color={0,0,
          127}));
  connect(botCyc.TExh, exhTep1.y) annotation (Line(points={{-11.3,10.3333},{-20,
          10.3333},{-20,60},{-59,60}},
                              color={0,0,127}));
  annotation (Icon(coordinateSystem(preserveAspectRatio=false)), Diagram(
        coordinateSystem(preserveAspectRatio=false)));
end BottomingCycle_test;
